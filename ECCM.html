<!doctype html>
<html lang="en">
<head>
<link type="image/png" sizes="32x32" rel="icon" href="https://img.icons8.com/stickers/32/ethernet-on.png">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ethernet Cable Connection Manager</title>
<style>
:root{--bg:#0f1115;--panel:#171a21;--ink:#e8eaf1;--paper: #0E1117;--muted:#a6adbb;--line:#262a33;--prtPortH: 75px;--portGapFull:9px;--portGapHalf:8px;--portW12:60px;--portW6:60px;--reserved-bg:#555;--elm-page-bg-dark:#0f172a;--elm-page-bg-bright:#ffffff}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
*,*::before,*::after{box-sizing:border-box}
header{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;flex-wrap:wrap;background:linear-gradient(180deg,#12151b,#10131a)}
header h1{font-size:18px;margin:0;font-weight:650}
.badge{color:var(--muted);font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:999px}
.wrap{position:relative;display:grid;grid-template-columns:340px 1fr;gap:0;height:calc(100% - 62px)}
@media (max-width:1024px){.wrap{grid-template-columns:1fr;height:auto}}
aside,main{padding:16px}
aside{border-right:1px solid var(--line);background:var(--panel)}
main{overflow:auto;position:relative}
.card{background:#141821;border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px}
.card h3{margin:0 0 8px 0;font-size:14px;font-weight:650}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
.muted{color:var(--muted)}.small{font-size:12px}
.mini{padding:4px 8px;font-size:12px;border-radius:6px}
.setting-row{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin:.5rem 0}
.setting-row select{padding:.35rem .5rem;border-radius:.5rem}
input[type=text],input[type=number],select{width:100%;max-width:100%;background:#0f131b;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px 10px;outline:none}
button,.btn{background:#11151d;color:var(--ink);border:1px solid var(--line);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
button:hover{border-color:#2a2f3b}
.btn-danger{border-color:#3b2222}
.dev-rows{display:flex;flex-direction:column;gap:12px}
.dev-row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.device-wrap{display:block;width:100%}
.device-wrap.full{grid-column:1/-1}
.device{background:#131722;border:1px solid var(--line);border-radius:12px;padding:12px;position:relative;width:100%}
.device-head{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
.device-title{font-size:15px;font-weight:650;display:flex;align-items:center;gap:8px}
.swatch{width:12px;height:12px;border-radius:3px;border:1px solid #0006;display:inline-block}
.device-actions{display:flex;gap:6px;flex-wrap:wrap}
.meta{font-size:12px;color:var(--muted);margin-top:2px}
.meta .inline-controls{margin-left:8px;display:inline-flex;gap:6px}
.ports-rows{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.port-row{display:grid;gap:var(--portGapHalf)}
.port{height: var(--prtPortH) !important;position:relative;border:1px solid var(--line);background:#0f141d;border-radius:10px;padding:4px 6px 6px;cursor:pointer;text-align:center;user-select:none;transition:background .12s}
.port .num{font-size:12px;margin-top:2px;min-height:1.4em}
.port .alias{font-size:12px;margin-top:2px;min-height:1.4em; white-space: nowrap;  overflow: hidden; text-align: center;  max-width: 100%;  }
.port .peer{margin-top:2px;font-size:12px;font-weight:700;min-height:1.4em;white-space: nowrap;  overflow: hidden; text-align: center;  max-width: 100%;}
.port.selected{}
.port:not(.connected):not(.reserved) .num,.port:not(.connected):not(.reserved) .alias,.port:not(.connected):not(.reserved) .peer{color:#fff}
.port.reserved .num,.port.reserved .alias,.port.reserved .peer{color:#fff!important}
.port .num{  display:inline-flex;  align-items:center;  justify-content:center;  gap:4px;  line-height:1;}
.port .num .num-label{ line-height:1; }
.port .ind{  width:5px; height:5px;  display:inline-block;  border-radius:1px;  background: currentColor;  opacity:.9;  line-height:0;  flex:0 0 auto;  vertical-align:middle;}
.port .ind.vlan-diamond{ transform: rotate(45deg); }
.port .ind.ind--off{  opacity:0;  pointer-events:none;  }
html.theme-bright .port .ind{ opacity:.8; }
.grid-slim{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:8px;overflow:hidden;table-layout:fixed}
.grid-slim th,.grid-slim td{font-size:13px;text-align:left;padding:8px 10px;border-bottom:1px solid var(--line);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.grid-slim th{background:#121722;color:var(--muted);font-weight:600}
.conn-row.highlight td{background:#1e293b }
.conn-row td.deviceA .devName,.conn-row td.deviceB .devName{color:#fff;font-weight:400}
.conn-row.highlight td.deviceA .devName,.conn-row.highlight td.deviceB .devName{color:var(--devColor);font-weight:700}
.conn-row.reserved-row td{background:#121622}
.conn-row.reserved-row:hover td{background:#151b2a}
.color-picker-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.swatch-lg{width:24px;height:24px;border-radius:6px;border:1px solid #0006;display:inline-block}
.color-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#0f141d;border:1px solid var(--line);border-radius:8px;cursor:pointer;font-weight:600;color:var(--ink)}
.color-btn:hover{border-color:#2a2f3b}
.palette-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999}
.palette{background:#141821;border:1px solid var(--line);border-radius:12px;padding:12px;min-width:280px;max-width:90vw}
.palette h4{margin:0 0 10px 0;font-size:14px}
.palette-grid{display:grid;grid-template-columns:repeat(4,36px);gap:8px;justify-content:center}
.chip{width:36px;height:36px;border-radius:8px;border:1px solid rgba(0,0,0,.35);cursor:pointer}
.palette .actions{display:flex;justify-content:flex-end;margin-top:12px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
.modal{background:#141821;border:1px solid var(--line);border-radius:12px;padding:14px;min-width:300px;max-width:90vw}
.modal h4{margin:0 0 10px 0;font-size:14px}
.modal .row{display:flex;gap:8px;align-items:center;margin:6px 0}
.modal label{margin:0;color:var(--ink);font-size:13px}
.modal select{background:#0f131b;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:6px 10px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
html.theme-bright body,html.theme-bright .card,html.theme-bright aside,html.theme-bright main,html.theme-bright #settingsPanel{background:#fff!important;color:#111!important;border-color:#ccc!important;--muted: #222; --paper: #fff}
html.theme-bright header{background:#fff!important;border-bottom:1px solid #e5e7eb!important;color:#111!important}
html.theme-bright header h1{color:#111!important}
html.theme-bright header .badge{background:#fff!important;color:#444!important;border-color:#e0e6ef!important}
html.theme-bright header button,html.theme-bright header .btn,html.theme-bright header select{background:#fff!important;color:#111!important;border:1px solid #d8dee8!important}
html.theme-bright header button:hover,html.theme-bright header .btn:hover{border-color:#9aa4b2!important}
html.theme-bright .device{background:#fff!important;border-color:#ccc!important}
html.theme-bright .port:not(.connected):not(.reserved){background:#fff!important;color:#000!important}
html.theme-bright .port:not(.connected):not(.reserved) .num,html.theme-bright .port:not(.connected):not(.reserved) .alias,html.theme-bright .port:not(.connected):not(.reserved) .peer{color:#000!important}
html.theme-bright .port.selected{}
html.theme-bright .port.reserved{background:#555!important;color:#fff!important}
html.theme-bright button:not(.chip),html.theme-bright .btn,html.theme-bright input[type="text"],html.theme-bright input[type="number"],html.theme-bright select{background:#fff!important;color:#111!important;border:1px solid #ccc!important}
html.theme-bright button:not(.chip):hover,html.theme-bright .btn:hover{border-color:#888!important}
html.theme-bright .grid-slim th{background:#f6f7f9!important;color:#111!important;border-color:#ccc!important}
html.theme-bright .grid-slim td{background:#fff!important;color:#111!important;border-color:#ddd!important}
html.theme-bright .conn-row.highlight td{background:#e8f0fe!important;color:#000!important}
html.theme-bright .conn-row.reserved-row td{background:#f1f1f1!important;color:#000!important}
html.theme-bright .conn-row.reserved-row:hover td{background:#e0e0e0!important}
html.theme-bright .conn-row td.deviceA .devName,html.theme-bright .conn-row td.deviceB .devName{color:#000!important;font-weight:400}
html.theme-bright .conn-row.highlight td.deviceA .devName,html.theme-bright .conn-row.highlight td.deviceB .devName{color:var(--devColor)!important;font-weight:700}
html.theme-bright .palette{background:#fff!important;border-color:#ccc!important;color:#000!important}
html.theme-bright .palette h4{color:#000!important}
html.theme-bright .palette .chip{border:1px solid rgba(0,0,0,.4)}
html.theme-bright .modal{background:#fff!important;border:1px solid #ccc!important;color:#111!important}
html.theme-bright .modal h4,html.theme-bright .modal label{color:#111!important}
html.theme-bright .modal select{background:#fff!important;color:#111!important;border:1px solid #ccc!important}
.theme-toggle{display:inline-flex;border-radius:10px;overflow:hidden}
.theme-toggle button{padding:6px 12px;border:1px solid var(--line);background:#11151d;color:var(--ink);cursor:pointer;font-weight:600;line-height:1;border-right:none}
.theme-toggle button:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
.theme-toggle button:last-child{border-right:1px solid var(--line);border-top-right-radius:10px;border-bottom-right-radius:10px}
.theme-toggle button.active{box-shadow:inset 0 0 0 2px #e5e7eb}
html.theme-bright .theme-toggle button{background:#fff;color:#111;border-color:#ccc}
html.theme-bright .theme-toggle button:last-child{border-right-color:#ccc}
html.theme-bright .theme-toggle button.active{box-shadow:inset 0 0 0 2px #000}
main::-webkit-scrollbar{width:10px}
main::-webkit-scrollbar-track{background:var(--panel)}
main::-webkit-scrollbar-thumb{background-color:#555;border-radius:6px;border:2px solid var(--panel)}
main::-webkit-scrollbar-thumb:hover{background-color:#777}
main{scrollbar-width:thin;scrollbar-color:#555 var(--panel)}
html.theme-bright main::-webkit-scrollbar-track{background:#fff!important}
html.theme-bright main::-webkit-scrollbar-thumb{background-color:#bbb!important;border:2px solid #fff!important}
html.theme-bright main::-webkit-scrollbar-thumb:hover{background-color:#999!important}
html.theme-bright main{scrollbar-color:#bbb #fff!important}
:root{  --hover-bg: #141821;  --hover-border: #2b3140;  --hover-ink: #e8eaf1;}
html.theme-bright{  --hover-bg: #fffffe;  --hover-border: #cfd6e4;  --hover-ink: #111;}
.hovercard{  position: fixed;  z-index: 9999;  display: none;  min-width: 220px;  max-width: 320px;  padding: 8px 10px;  font-size: 12px;  line-height: 1.3;  color: var(--hover-ink);  background: var(--hover-bg);  border: 1px solid var(--hover-border);  border-radius: 10px;  box-shadow: 0 6px 20px rgba(0,0,0,.25);  pointer-events: none;   white-space: nowrap;}
.hovercard .hc-title{ font-weight: 700; margin-bottom: 4px; }
.hovercard .hc-row{ display:flex; gap:8px; }
.hovercard .hc-k{ color: var(--muted); min-width: 72px; }
.port .spd{  display:inline-block;  margin-left:6px;  padding:1px 6px;  font-size:10px;  line-height:1.3;  border:1px solid var(--line);  border-radius:999px;  color: var(--muted);  vertical-align:middle;}
.speed-menu{  position: fixed;  z-index: 9999;  background:#141821;  color:#e8eaf1;  border:1px solid var(--line);  border-radius:8px;  padding:6px;  box-shadow: 0 8px 24px rgba(0,0,0,.35);}
.speed-menu select{  background:#0f131b;  color:#e8eaf1;  border:1px solid var(--line);  border-radius:6px;  padding:6px 8px;  font-size:12px;}
html.theme-bright .speed-menu{  background:#fff;  color:#111;  border-color:#ccc;}
html.theme-bright .speed-menu select{  background:#fff;  color:#111;  border-color:#ccc;}
.slideover{  position: fixed;  inset: 0;  z-index: var(--z-overlay, 5000);  display: none;  font: inherit;  color: var(--ink);}
.slideover.is-open{ display:block; }
.slideover__backdrop{  position: absolute;  inset: 0;  background: var(--overlay, rgba(0,0,0,.35)); /* follows page; override if you have a var */  opacity: 0;  transition: opacity .2s ease;}
.slideover.is-open .slideover__backdrop{ opacity: 1; }
.slideover__panel{  position: absolute;  top: 0; right: 0; bottom: 0;  width: clamp(320px, 36vw, 480px);  background: var(--paper);  color: var(--ink);  border-left: 1px solid var(--line);  box-shadow: -12px 0 32px var(--elev, rgba(0,0,0,.28));  display: flex; flex-direction: column;  transform: translateX(100%);  transition: transform .25s ease;}
.slideover.is-open .slideover__panel{ transform: translateX(0); }
.slideover__header,
.slideover__footer{  background: var(--paper);  color: var(--ink);  padding: 12px 16px;}
.slideover__header{  display:flex; align-items:center; justify-content:space-between;  border-bottom: 1px solid var(--line);}
.slideover__footer{  border-top: 1px solid var(--line);}
.slideover__header h2{  margin: 0;  font-size: 18px;  font-weight: 600;  color: var(--ink);}
.slideover__body{  padding: 12px 16px;  overflow: auto;  flex: 1 1 auto;  background: var(--paper);  color: var(--ink);}
.slideover__close{  font-size: 28px; line-height: 1;  border: 0; background: transparent; color: var(--ink);  cursor: pointer;}
@media (prefers-color-scheme: dark){  .slideover__backdrop{    background: var(--overlay-dark, rgba(0,0,0,.6));  }}
@media (prefers-reduced-motion: reduce){  .slideover__backdrop,  .slideover__panel{ transition: none; }}
@media print{  .slideover{ display:none !important; }
input[type=range][orient=vertical] {  appearance: slider-vertical;  width: 8px;}
#customColorPicker input[type=range] {  margin: 0 2px;}
#colorPreviewBox {  box-shadow: 0 0 6px rgba(0,0,0,0.4);}
#hexOutput:focus {  outline: none;  border-color: #66ccff;}
#hueBar {  border: 1px solid var(--line);}
#hueMarker {  transition: top 0.1s ease;}
#colorPreviewBox {  transition: background 0.15s ease;}
#hexOutput {  width: 80px;  font-size: 12px;  margin-top: 4px;}
</style>
</head>
<body>
<header>
  <h1>Ethernet Cable Connection Manager</h1>
  <span class="badge">1.0.4</span>
  <div style="margin-left:auto;display:flex;gap:8px">
	<button id="btnSettings" class="btn">Settings</button>
    <button id="printSheet">Print layout</button>
  </div>
</header>

<div class="wrap">
  <aside>
    <!-- Profiles -->
    <div class="card">
      <h3>Profiles</h3>
      <label for="profileSelect">Active profile</label>
      <select id="profileSelect"></select>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="newProfileBtn">New</button>
        <button id="renameProfileBtn">Rename</button>
        <button id="duplicateProfileBtn">Duplicate</button>
        <button id="deleteProfileBtn" class="btn-danger">Delete</button>
        <button id="exportProfileBtn" class="btn">Export</button>
        <button id="importProfileBtn" class="btn">Import</button>
        <input id="importProfileFile" type="file" accept=".json,application/json" style="display:none">
      </div>

      <div class="small muted" style="margin-top:6px">
      </div>
    </div>

    <div class="card">
      <h3>Add device</h3>
      <label for="devName">Name</label>
      <input id="devName" type="text" placeholder="e.g. Core Switch A" />
      <div class="row">
        <div>
          <label for="devPorts">Ports</label>
          <input id="devPorts" type="number" inputmode="numeric" min="1" max="9999" value="24" />
        </div>
      </div>
      <label>Colour</label>
      <div class="color-picker-row">
        <button type="button" class="color-btn" id="openPalette">Select colour</button>
        <span id="devColorPreview" class="swatch swatch-lg" title="Selected colour"></span>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="addBtn">Add device</button>
        <button id="clearAll" class="btn-danger" title="Delete everything">Clear all devices</button>
      </div>
      <div class="small muted" style="margin-top:6px">
        Click two free ports to connect<br>
		<strong>Unlink</strong> in Connections<br>
		<strong>Alt-click</strong> a port to set an alias<br>
		<strong>CTRL-click</strong> to mark as Reserved.
      </div>
    </div>

    <!-- Backup/restore all profiles -->
    <div class="card">
      <h3>Backup / Restore (all profiles)</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="backupAllBtn" class="btn">Backup all</button>
        <button id="restoreAllBtn" class="btn">Restore all</button>
        <input id="restoreAllFile" type="file" accept=".json,application/json" style="display:none">
      </div>
      <div class="small muted" style="margin-top:6px">Saves or restores every profile on this device.</div>
    </div>

    <div class="card">
      <h3>Find connection</h3>
      <input id="searchBox" type="text" placeholder="Filter by device, port, alias, or reserved‚Ä¶" />
      <div class="small muted" style="margin-top:6px">Filters the connections table.</div>
    </div>
  </aside>

  <main>
    <div class="card">
      <h3>Devices</h3>
      <div id="devRows" class="dev-rows"></div>
    </div>

    <div class="card">
      <h3>Connections</h3>
      <table class="grid-slim" id="connTable">
        <thead><tr><th>#</th><th>Device A</th><th>Port</th><th>Alias</th><th>‚áÑ</th><th>Device B</th><th>Port</th><th>Alias</th><th></th></tr></thead>
        <tbody id="connBody"></tbody>
      </table>
      <div class="small muted">Click a row (or a connected port) to highlight both ends.</div>
    </div>
  </main>
  


  </div>
</aside>
</div>

<!-- Settings Slide-Over (Modal) -->
<div id="settingsModal" class="slideover" aria-hidden="true">
  <div class="slideover__backdrop" data-close></div>
  <aside class="slideover__panel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" tabindex="-1">
    <header class="slideover__header">
      <h3>Settings</h3>
    </header>

    <div class="slideover__body" id="settingsPanelBody">
	
	<div class="card">
	<div class="setting-row" id="themeRow">
		<label>Theme</label>
		<div class="theme-toggle" role="group" aria-label="Theme">
			<button type="button" id="themeDark"  data-theme="dark"   aria-pressed="false">üåô Dark</button>
			<button type="button" id="themeLight" data-theme="bright" aria-pressed="false">‚òÄÔ∏è Light</button>
		</div>
	</div>
	</div>
	
        <div class="card">
	
	<div class="setting-row">
		<label for="enablePortRename">Enable Port Renaming</label>
		<input id="enablePortRename" type="checkbox" />
	</div>
	<div class="setting-row">
	  <label for="maxPorts" style="flex:1;">Maximum ports per device</label>
	  <input id="maxPorts" type="number" min="0" max="9999" style="flex:1; max-width:120px;" />
	</div>
	
	
	<div style="margin-top:10px;display:flex;gap:8px">
	  <button id="saveSettingsBtn" class="btn">Save</button>
	</div>

  </div>
    </div>

    <footer class="slideover__footer">
      <button class="btn" data-close>Close</button>
    </footer>
  </aside>
</div>


<!-- Palette -->
<div class="palette-backdrop" id="paletteModal">
  <div class="palette" role="dialog" aria-modal="true" aria-labelledby="paletteTitle">
  <h4 id="paletteTitle">Select colour</h4>
	  <div style="display:flex;gap:20px;justify-content:center;align-items:flex-start;flex-wrap:wrap">
		<div class="palette-grid" id="paletteGrid" style="grid-template-columns:repeat(4,36px)"></div>
	  </div>
	  <div class="actions"><button type="button" id="paletteClose">Close</button></div>
	</div>

</div>

<!-- Layout modal -->
<div class="modal-backdrop" id="layoutModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="layoutTitle">
    <h4 id="layoutTitle">Device layout options</h4>
    <div class="row"><label style="min-width:110px">Device</label><span id="layoutDeviceName" class="small muted"></span></div>
    <div class="row">
      <label style="min-width:110px">Row width</label>
      <select id="layoutFullRow">
        <option value="auto">Auto (follow rules)</option>
        <option value="full">Force full row</option>
      </select>
    </div>
    <div class="row" id="optMidWrap">
      <label style="min-width:110px">13‚Äì24 ports</label>
      <select id="layoutMidWrap">
        <option value="balanced">Balanced (¬Ω + ¬Ω)</option>
        <option value="twelve">12 + remainder</option>
      </select>
    </div>
    <div class="row" id="optSmallWrap">
      <label style="min-width:110px">‚â§12 ports</label>
      <select id="layoutSmallWrap">
        <option value="single">Single row</option>
        <option value="split">Split into 2 rows</option>
      </select>
    </div>
    <div class="row" id="optDualLink">
      <label style="min-width:110px">Dual link</label>
      <select id="layoutDualLink">
        <option value="off">Normal</option>
        <option value="on">Dual link</option>
      </select>
    </div>
	<div class="row" id="optNumbering">
	  <label style="min-width:110px">Port numbering</label>
	  <select id="layoutNumbering">
		<option value="row">Left ‚Üí Right (rows)</option>
		<option value="column">Top ‚Üì Bottom (columns)</option>
	  </select>
	</div>
    <div class="actions">
      <button type="button" id="layoutCancel">Cancel</button>
      <button type="button" id="layoutSave">Save</button>
    </div>
  </div>
</div>

<!-- Edit Device Modal -->
<div class="modal-backdrop" id="editDeviceModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editDeviceTitle">
    <h4 id="editDeviceTitle">Edit Device</h4>

    <div class="row">
      <label for="editDevName" style="min-width:100px">Name</label>
      <input id="editDevName" type="text" placeholder="Device name" />
    </div>

    <div class="row">
      <label for="editDevPorts" style="min-width:100px">Ports</label>
      <input id="editDevPorts" type="number" min="1" max="9999" />
    </div>

    <div class="row">
      <label style="min-width:100px">Colour</label>
      <div class="color-picker-row">
        <button type="button" class="color-btn" id="editOpenPalette">Select colour</button>
        <span id="editDevColorPreview" class="swatch swatch-lg" title="Selected colour"></span>
      </div>
    </div>

    <div class="actions">
      <button type="button" id="editDevCancel">Cancel</button>
      <button type="button" id="editDevSave" class="btn">Save</button>
    </div>
  </div>
</div>


<script>
/* ===================== HIGHLIGHT TUNING ===================== */
const HI_OUTLINE = 0; // px: outer white ring 
const HI_RING    = 5; // px: inner white ring thickness
const HI_BLUR    = 0; // px: inner white glow blur

/* ===================== PROFILES STORAGE ===================== */
var STORE_KEY = 'ethcm_profiles_v1';
var OLD_SINGLE_KEY = 'ethcm_v12';
var defaultState = { devices: [], links: [], portAliases: {}, reservedPorts: {}, portSpeeds: {}, portVlans: {} };
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function uid(){ return 'id_' + Math.random().toString(36).slice(2,10); }

var store = (function(){
  try{
    var raw = localStorage.getItem(STORE_KEY);
    if(raw){
      var parsed = JSON.parse(raw);
      if(parsed && parsed.current && parsed.profiles) return parsed;
    }
    var oldRaw = localStorage.getItem(OLD_SINGLE_KEY);
    if(oldRaw){
      var one = JSON.parse(oldRaw);
      normalizeState(one);
      return { current:'Migrated', profiles:{ 'Migrated': one } };
    }
  }catch(e){}
  return { current:'Default', profiles:{ 'Default': deepClone(defaultState) } };
})();
function normalizeState(st){
  st.devices = Array.isArray(st.devices) ? st.devices : [];
  st.links = Array.isArray(st.links) ? st.links : [];
  st.portAliases = st.portAliases || {};
  st.reservedPorts = st.reservedPorts || {};
  st.portSpeeds = st.portSpeeds || {};
  st.devices.forEach(function(d){
	  if (d.forceFullRow === undefined) d.forceFullRow = false;
	  if (d.midWrapMode === undefined) d.midWrapMode = 'balanced';
	  if (d.smallWrap === undefined) d.smallWrap = false;
	  if (d.dualLink === undefined) d.dualLink = false;
	  if (d.numbering === undefined) d.numbering = 'row';
});
}
function saveStore(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch(e){} }

/* Active profile reference */
var state = store.profiles[store.current];

/* ===================== DOM HELPERS ===================== */
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
function el(tag, attrs){
  var node = document.createElement(tag); attrs = attrs||{};
  Object.keys(attrs).forEach(function(k){
    var v = attrs[k];
    if(k === 'dataset'){ Object.keys(v).forEach(function(dk){ if(v[dk]!==undefined) node.dataset[dk] = v[dk]; }); }
    else if(k === 'class'){ node.className = v; }
    else if(k.indexOf('on') === 0 && typeof v === 'function'){ node.addEventListener(k.slice(2), v); }
    else { node.setAttribute(k, v); }
  });
  for(var i=2;i<arguments.length;i++){ var c = arguments[i]; if(c==null) continue; node.appendChild(c.nodeType ? c : document.createTextNode(c)); }
  return node;
}
function deviceById(id){ for(var i=0;i<state.devices.length;i++){ if(state.devices[i].id===id) return state.devices[i]; } return null; }
function indexById(id){ return state.devices.findIndex(function(d){return d.id===id;}); }

/* ===================== LINK/RESERVED HELPERS (dual-aware) ===================== */
function keyFor(deviceId, port, sub){ return deviceId + ':' + port + ':' + (sub==null ? '' : sub); }
function aliasFor(deviceId, port, sub){ return state.portAliases[keyFor(deviceId,port,sub)] || ''; }
function reservedLabelFor(deviceId, port, sub){
  return (state.reservedPorts && state.reservedPorts[keyFor(deviceId,port,sub)]) || null;
}
function isReservedPort(deviceId, port, sub){
  return !!reservedLabelFor(deviceId, port, sub);
}
function linkForPort(deviceId, port, sub){
  for(var i=0;i<state.links.length;i++){
    var L = state.links[i];
    if((L.a.deviceId===deviceId && L.a.port===port && (L.a.sub||null)===(sub||null)) ||
       (L.b.deviceId===deviceId && L.b.port===port && (L.b.sub||null)===(sub||null))) return L;
  }
  return null;
}
function getPeer(deviceId, port, sub){
  var L = linkForPort(deviceId, port, sub); if(!L) return null;
  if (L.a.deviceId===deviceId && L.a.port===port && (L.a.sub||null)===(sub||null)) return L.b;
  return L.a;
}
function connectPorts(a,b){
  if (linkForPort(a.deviceId,a.port,a.sub) || linkForPort(b.deviceId,b.port,b.sub)) return false;
  if (isReservedPort(a.deviceId,a.port,a.sub) || isReservedPort(b.deviceId,b.port,b.sub)) return false;
  var id = uid(); state.links.push({ id:id, a:a, b:b }); saveStore(); render(); highlightLink(id); return true;
}
function speedFor(deviceId, port, sub){
  return (state.portSpeeds || {})[keyFor(deviceId,port,sub)] || '';
}
function setSpeedFor(deviceId, port, sub, val){
  var k = keyFor(deviceId,port,sub);
  state.portSpeeds = state.portSpeeds || {};
  if (!val) delete state.portSpeeds[k]; else state.portSpeeds[k] = String(val);
  saveStore();
}

function vlanFor(deviceId, port, sub){
  var v = (state.portVlans || {})[keyFor(deviceId,port,sub)];
  return (v==null || v==='') ? '' : Number(v);
}
function setVlanFor(deviceId, port, sub, val){
  var k = keyFor(deviceId,port,sub);
  state.portVlans = state.portVlans || {};
  if (val==null || val==='') { delete state.portVlans[k]; }
  else {
    var n = Math.max(1, Math.min(4094, Number(val)||0)); // clamp 1‚Äì4094
    state.portVlans[k] = n;
  }
  saveStore();
}

function fmtSpeed(val){
  // normalize display
  switch(String(val||'')){
    case '100 Mbit': return '100 Mbit';
    case '1 Gbit': return '1 Gbit';
    case '2.5 Gbit': return '2.5 Gbit';
    case '5 Gbit': return '5 Gbit';
    case '10 Gbit': return '10 Gbit';
    case '25 Gbit': return '25 Gbit';
    case '40 Gbit': return '40 Gbit';
    case '100 Gbit': return '100 Gbit';
    default: return '';
  }
}


/* ===================== COLOUR / SELECTION ===================== */
function hexToRgb(hex){ var h = String(hex||'').replace('#','').trim(); if (h.length===3) h = h.split('').map(function(c){return c+c}).join(''); var n = parseInt(h,16); if (isNaN(n)||h.length!==6) return {r:15,g:20,b:29}; return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
function bestTextColorFor(bgHex){ var c = hexToRgb(bgHex); var L = 0.2126*(c.r/255) + 0.7152*(c.g/255) + 0.0722*(c.b/255); return (L > 0.6) ? '#000' : '#fff'; }
function paintPortBase(node, bgHex){
  var bg = bgHex || '#0f141d';
  node.style.background = bg;
  node.style.borderRadius = '10px';
  var txt = bestTextColorFor(bg);
  node.style.color = txt;
  var alias = node.querySelector('.alias'); if (alias) alias.style.color = txt;
  var num   = node.querySelector('.num');   if (num)   num.style.color   = txt;
  var peer  = node.querySelector('.peer');  if (peer)  peer.style.color  = txt;
}

/* CLEAR selection visuals */
function clearSelectionOutlines(){
  $all('.port.selected').forEach(function(n){
    n.classList.remove('selected');
    n.style.boxShadow = 'none';
  });
}

/* APPLY selection visuals: same on singles and dual halves */
function outlineForSelection(node){
  node.classList.add('selected');

  var isBright = document.documentElement.classList.contains('theme-bright');
  var edgeClr = isBright ? '#000' : '#fff';
  var glowClr = isBright ? 'rgba(0,0,0,.38)' : 'rgba(255,255,255,.38)';

  var o = HI_OUTLINE, r = HI_RING, b = HI_BLUR;
  node.style.boxShadow =
    '0 0 0 ' + o + 'px ' + edgeClr + ',' +
    'inset 0 0 0 ' + r + 'px ' + edgeClr + ',' +
    'inset 0 0 ' + b + 'px ' + glowClr;
}

/* ---------- Hovercard (only shows while item is highlighted) ---------- */
var __hoverEl = null;

function hcEnsure(){
  if (!__hoverEl){
    __hoverEl = document.createElement('div');
    __hoverEl.className = 'hovercard';
    document.body.appendChild(__hoverEl);
  }
  return __hoverEl;
}
function hcHide(){ if(__hoverEl) __hoverEl.style.display = 'none'; }

function hcShowForTarget(target, html, evt){
  var el = hcEnsure();
  el.innerHTML = html;
  el.style.display = 'block';
  var x = 0, y = 0;
  if (evt && typeof evt.clientX === 'number'){
    x = evt.clientX + 14;
    y = evt.clientY + 12;
  } else {
    var r = target.getBoundingClientRect();
    x = r.right + 12;
    y = r.top + 8;
  }
  // Keep in viewport
  var vw = window.innerWidth, vh = window.innerHeight;
  var ew = el.offsetWidth || 240, eh = el.offsetHeight || 100;
  if (x + ew + 8 > vw) x = vw - ew - 8;
  if (y + eh + 8 > vh) y = vh - eh - 8;
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
}

/* Hide the hovercard whenever selection is cleared */
const __orig_clearSel = clearSelectionOutlines;
clearSelectionOutlines = function(){
  hcHide();
  return __orig_clearSel.apply(this, arguments);
};
/* Also hide when we un-highlight a link */
const __orig_highlightLink = highlightLink;
highlightLink = function(id, opts){
  if (!id) hcHide();
  return __orig_highlightLink.apply(this, arguments);
};


/* ===================== UNIFORM PORT WIDTHS (two gaps) ===================== */
function updateUniformPortWidth(){
  var host = document.getElementById('devRows'); if(!host) return;
  var GAP_COL = 12;
  var PAD_BRD = 26;
  var gapFull = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--portGapFull')) || 9;
  var gapHalf = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--portGapHalf')) || 8;
  var Wrows = host.getBoundingClientRect().width || 800;
  var WfullInner = Wrows - PAD_BRD;
  var WhalfInner = ((Wrows - GAP_COL)/2) - PAD_BRD;
  var portW12 = (WfullInner - (11*gapFull)) / 12;
  var portW6  = (WhalfInner - (5*gapHalf)) / 6;
  portW12 = Math.max(40, portW12);
  portW6  = Math.max(40, portW6);
  document.documentElement.style.setProperty('--portW12', portW12 + 'px');
  document.documentElement.style.setProperty('--portW6',  portW6  + 'px');
}
var __pw_timer=null;
window.addEventListener('resize', function(){ clearTimeout(__pw_timer); __pw_timer=setTimeout(updateUniformPortWidth, 60); });

/* ===================== LAYOUT RULES ===================== */
function isFullWidthDevice(d){
  if (d.forceFullRow) return true;
  if ((d.ports||1) >= 13) return true;
  if ((d.ports||1) >= 7 && !d.smallWrap) return true;
  return false;
}
function splitPortsIntoRows(n, dev){
  if (n === 12 && dev.smallWrap) return [6, 6];

  if (n >= 12){
    if (n >= 13 && n <= 24 && dev.midWrapMode === 'balanced'){
      var a = Math.ceil(n/2);
      return [Math.min(12, a), Math.min(12, n - a)];
    }
    var rows = [], rem = n;
    while (rem > 0){ rows.push(Math.min(12, rem)); rem -= 12; }
    return rows;
  }
  if (n >= 7){
    if (dev.smallWrap){ var a = Math.ceil(n/2); return [a, n - a]; }
    return [n];
  }
  return [n];
}


/* ===================== CONNECT SELECTION ===================== */
var pendingPort = null;
var highlightedLinkId = null;

/* ===================== RENDER DEVICES ===================== */
function renderDevices(){
  var host = $('#devRows'); host.innerHTML='';
  if(!state.devices.length){ host.appendChild(el('div',{class:'muted'},'No devices yet ‚Äî add one on the left.')); updateUniformPortWidth(); return; }

  var i=0;
  while(i < state.devices.length){
    var rowEl = el('div',{class:'dev-row'});
    var d = state.devices[i];
    if (isFullWidthDevice(d)){
      rowEl.appendChild(renderDeviceWrap(d, true)); i += 1;
    } else {
      rowEl.appendChild(renderDeviceWrap(d, false));
      if (i+1 < state.devices.length && !isFullWidthDevice(state.devices[i+1])){
        rowEl.appendChild(renderDeviceWrap(state.devices[i+1], false)); i += 2;
      } else {
        rowEl.appendChild(el('div',{class:'device-wrap'}, el('div',{class:'device', style:'visibility:hidden'}, ' '))); i += 1;
      }
    }
    host.appendChild(rowEl);
  }
  updateUniformPortWidth();
}

function renderDeviceWrap(d, fullWidth){
  var wrap = el('div',{class:'device-wrap ' + (fullWidth ? 'full' : ''), dataset:{id:d.id}});
  wrap.draggable = true;

  wrap.addEventListener('dragstart', function(e){
    wrap.classList.add('dragging');
    e.dataTransfer.setData('text/plain', d.id);
    e.dataTransfer.effectAllowed='move';
  });
  wrap.addEventListener('dragend', function(){ wrap.classList.remove('dragging'); });
  wrap.addEventListener('dragover', function(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
  wrap.addEventListener('drop', function(e){
    e.preventDefault();
    var draggedId = e.dataTransfer.getData('text/plain'); if (!draggedId || draggedId === d.id) return;
    var from = indexById(draggedId), to = indexById(d.id); if (from<0 || to<0) return;
    var item = state.devices.splice(from,1)[0]; if (from < to) to -= 1; state.devices.splice(to,0,item);
    saveStore(); render();
  });

  var head = el('div',{class:'device-head'},
    el('div',{class:'device-title'},
      el('span',{class:'swatch', style:'background:'+(d.color||'#888')}),
      document.createTextNode(d.name||'Unnamed')
    ),
    el('div',{class:'device-actions'},
      el('button',{title:'Layout options', onclick:function(ev){ ev.stopPropagation(); openLayoutModal(d.id); }}, 'Layout'),
		el('button', {
		  title: 'Edit device',
		  onclick: function (ev) {
			ev.stopPropagation();
			openEditDeviceModal(d.id);
		  }
		}, 'Edit'),
      el('button',{class:'btn-danger',title:'Delete', onclick:function(ev){
        ev.stopPropagation();
        if(!confirm('Delete "'+(d.name||'Unnamed')+'" and its links?')) return;
        state.links = state.links.filter(function(L){
          return String(L.a.deviceId)!==String(d.id) && String(L.b.deviceId)!==String(d.id);
        });
        state.devices = state.devices.filter(function(x){ return String(x.id)!==String(d.id); });
        Object.keys(state.portAliases).forEach(function(k){
          if(k.split(':')[0]===String(d.id)) delete state.portAliases[k];
        });
        saveStore(); render();
      }}, 'Delete')
    )
  );

  var meta = el('div',{class:'meta'},
    document.createTextNode((d.ports||1)+' ports'),
    (function(){
      var c = el('span',{class:'inline-controls'},
        el('button',{class:'mini', title:'Add one port', onclick:function(e){ e.stopPropagation(); changePorts(d, (d.ports||1)+1); saveStore(); render(); }}, '+ Port'),
        el('button',{class:'mini', title:'Remove one port', onclick:function(e){ e.stopPropagation(); if ((d.ports||1) <= 1) return; changePorts(d, (d.ports||1)-1); saveStore(); render(); }}, '‚Äì Port')
      );
      return c;
    })()
  );

  var portsContainer = el('div',{class:'ports-rows'});
var rows = splitPortsIntoRows(d.ports||1, d);
var total = d.ports || 1;
var seqByRow = rows.map(function(cnt){ return new Array(cnt); });

function buildRowMajor(){
  var n = 1;
  rows.forEach(function(count, r){
    for (var c=0; c<count; c++) seqByRow[r][c] = n++;
  });
}

function buildColumnMajor(){
  var maxCols = Math.max.apply(null, rows);
  var n = 1;
  for (var c=0; c<maxCols && n<=total; c++){
    for (var r=0; r<rows.length && n<=total; r++){
      if (c < rows[r]) { seqByRow[r][c] = n++; }
    }
  }
  for (var r=0; r<rows.length; r++){
    for (var c=0; c<rows[r]; c++){
      if (seqByRow[r][c] == null) seqByRow[r][c] = n++;
    }
  }
}

// Choose numbering mode
if (d.numbering === 'column') buildColumnMajor();
else buildRowMajor();

  function createSubPort(d, p, sub){
  var linked   = !!linkForPort(d.id, p, sub);
  var peer     = linked ? getPeer(d.id,p,sub) : null;
  var peerDev  = peer ? deviceById(peer.deviceId) : null;
  var peerPort = peer ? peer.port : null;
  var alias    = aliasFor(d.id,p,sub);
  var reserved = reservedLabelFor(d.id,p,sub);

  var rawSpeed = (typeof speedFor === 'function') ? speedFor(d.id, p, sub) : '';
  var spdVal   = fmtSpeed(rawSpeed) || '';
  var vlanVal  = (typeof vlanFor === 'function') ? vlanFor(d.id, p, sub) : '';

  var hasSpeed = (rawSpeed !== '' && rawSpeed != null);
  var hasVlan  = (vlanVal  !== '' && vlanVal  != null);

var leftInd  = el('span',{class:'ind spd-dot'}, '');
var rightInd = el('span',{class:'ind vlan-diamond'}, '');

if (hasSpeed){
  leftInd.title = spdVal;
} else {
  leftInd.classList.add('ind--off');
}

if (hasVlan){
  rightInd.title = String(vlanVal);
} else {
  rightInd.classList.add('ind--off');
}

var portLabel = 
  (d.portNames && d.portNames[keyFor(d.id, p, sub)]) ||
  ('Port ' + p + (sub != null ? '/' + (sub + 1) : ''));

var numEl = el('div',{class:'num'},
  leftInd,
  el('span',{class:'num-label'}, portLabel),
  rightInd
);

function bindMiniHover(indEl, label, value){
  if(!indEl || indEl.classList.contains('ind--off')) return;
  indEl.addEventListener('mouseenter', function(e){
    hcShowForTarget(indEl,
      '<div class="hc-title">'+label+'</div><div>'+value+'</div>', e);
  });
  indEl.addEventListener('mousemove', function(e){
    hcShowForTarget(indEl,
      '<div class="hc-title">'+label+'</div><div>'+value+'</div>', e);
  });
  indEl.addEventListener('mouseleave', hcHide);
}
bindMiniHover(leftInd,  'Link speed', spdVal);
bindMiniHover(rightInd, 'VLAN',  String(vlanVal));


  var node = el('div',{
      class:'port'+(linked?' connected':'')+(reserved?' reserved':''), 
      dataset:{deviceId:d.id, port:p, sub:(sub==null?undefined:sub)}
    },
    numEl, 
    el('div',{class:'alias'}, alias||''),
    el('div',{class:'peer'}, reserved ? (reserved||'Reserved') : (peerPort?String(peerPort):''))
  );

  if (reserved){
    paintPortBase(node, 'var(--reserved-bg)');
  } else if (linked && peerDev){
    paintPortBase(node, peerDev.color || '#22354a');
  } else {
    paintPortBase(node, '#0f141d');
  }

  node.addEventListener('click', function(ev){
    if (ev.altKey){
      var curr = aliasFor(d.id,p,sub);
      var next = prompt('Optional port label (blank to clear):', curr||'');
      if(next===null) return;
      var k = keyFor(d.id,p,sub);
      if(!next.trim()) delete state.portAliases[k]; else state.portAliases[k] = next.trim();
      saveStore(); render(); return;
    }

    if (ev.ctrlKey){
      var k = keyFor(d.id,p,sub);
      if (state.reservedPorts && state.reservedPorts[k]){
        if(confirm('Clear reserved status for Port '+p+(sub!=null?('/'+(sub+1)):'')+'?')){
          delete state.reservedPorts[k];
        }
      } else {
        if (!state.reservedPorts) state.reservedPorts = {};
        var lbl = prompt('Reserved port label (e.g. WAN):', '');
        if (lbl===null) return;
        state.reservedPorts[k] = (lbl && lbl.trim()) ? lbl.trim() : 'Reserved';
      }
      pendingPort = null;
      saveStore(); render();
      return;
    }

    if (reserved){
      clearSelectionOutlines();
      outlineForSelection(node);
      highlightedLinkId = null; applyRowHighlight();
      pendingPort = null;
      return;
    }

    if (linkForPort(d.id, p, sub)) {
      clearSelectionOutlines();
      var L1 = linkForPort(d.id, p, sub);
      highlightLink(L1.id, { from:{deviceId:d.id, port:p, sub:sub} });
      pendingPort = null; return;
    }

    if (!pendingPort){
      pendingPort = {deviceId:d.id, port:p, sub:sub};
      clearSelectionOutlines(); outlineForSelection(node);
      highlightedLinkId = null; applyRowHighlight();
      return;
    }
    if (linkForPort(d.id, p, sub) || linkForPort(pendingPort.deviceId, pendingPort.port, pendingPort.sub) ||
        isReservedPort(d.id,p,sub) || isReservedPort(pendingPort.deviceId,pendingPort.port,pendingPort.sub)){
      alert('That port (or the previously selected one) is unavailable. Unlink/clear Reserved first.');
      pendingPort = null; clearSelectionOutlines(); highlightLink(null); return;
    }

    var devA = deviceById(pendingPort.deviceId);
    var devB = deviceById(d.id);
    var msg = 'Create link:\n' + (devA?devA.name:'A') + ' Port ' + pendingPort.port + (pendingPort.sub!=null?'/'+(pendingPort.sub+1):'')
              + ' ‚áÑ ' + (devB?devB.name:'B') + ' Port ' + p + (sub!=null?'/'+(sub+1):'');
    if (!confirm(msg)){ pendingPort = null; clearSelectionOutlines(); return; }
    var ok = connectPorts(pendingPort, {deviceId:d.id, port:p, sub:sub});
    pendingPort = null;
    if (!ok){ alert('Could not connect.'); clearSelectionOutlines(); highlightLink(null); }
  });

  function buildHoverHTML() {
    var liveAlias = aliasFor(d.id, p, sub) || '‚Äî';
    var liveSpeed = (typeof speedFor === 'function' ? fmtSpeed(speedFor(d.id, p, sub)) : '') || '‚Äî';

    var vlanRaw  = (typeof vlanFor==='function' ? vlanFor(d.id, p, sub) : '');
    var vlanText = (vlanRaw === '' ? '‚Äî' : vlanRaw);

    var liveReserved = typeof isReservedPort === 'function' && isReservedPort(d.id, p, sub);
    var liveLink = linkForPort(d.id, p, sub);
    var status = liveReserved ? 'Reserved' : (liveLink ? 'Linked' : 'Free');

    var peerTxt = '‚Äî';
    if (liveReserved) {
      peerTxt = (typeof reservedLabelFor === 'function' && reservedLabelFor(d.id, p, sub)) || 'Reserved';
    } else if (liveLink) {
      var livePeer = getPeer(d.id, p, sub);
      var livePeerDev = livePeer ? deviceById(livePeer.deviceId) : null;
      if (livePeer && livePeerDev) {
        peerTxt = livePeerDev.name + ' ‚Ä¢ Port ' + livePeer.port +
                  (livePeer.sub != null ? '/' + (livePeer.sub + 1) : '');
      }
    }

    return (
      '<div class="hc-title">' + (d.name || 'Device') + '</div>' +
      '<div class="hc-row"><div class="hc-k">Port</div><div>' +
        p + (sub != null ? '/' + (sub + 1) : '') + '</div></div>' +
      '<div class="hc-row"><div class="hc-k">Alias</div><div>' + liveAlias + '</div></div>' +
      '<div class="hc-row"><div class="hc-k">Peer</div><div>' + peerTxt + '</div></div>'+	
      '<div class="hc-row"><div class="hc-k">Status</div><div>' + status + '</div></div>' +
      '<div class="hc-row"><div class="hc-k">Link speed</div><div>' + liveSpeed + '</div></div>' +
      '<div class="hc-row"><div class="hc-k">VLAN</div><div>' + vlanText  + '</div></div>'
    );
  }

	node.addEventListener('mouseenter', function (e) {
	  if (__menuOpen || !node.classList.contains('selected')) return;
	  hcShowForTarget(node, buildHoverHTML(), e);
	});
	node.addEventListener('mousemove', function (e) {
	  if (__menuOpen || !node.classList.contains('selected')) return;
	  hcShowForTarget(node, buildHoverHTML(), e);
	});

  node.addEventListener('mouseleave', function () { hcHide(); });

  node.addEventListener('contextmenu', function(ev){
    openSpeedMenu(ev, d.id, p, sub);
  });

  return node;
}


  function renderPortCell(d, p){
    if (!d.dualLink) return createSubPort(d, p, null);
    var wrapCell = document.createElement('div');
    wrapCell.className = 'dual-cell';
    wrapCell.style.display = 'flex';
    wrapCell.style.flexDirection = 'column';
    wrapCell.style.border = '1px solid var(--line)';
    wrapCell.style.borderRadius = '10px';
    wrapCell.style.overflow = 'hidden';
    wrapCell.style.background = 'transparent';
    var top = createSubPort(d, p, 0);
    top.style.border = '0';
    top.style.borderRadius = '10px 10px 0 0';
    var bottom = createSubPort(d, p, 1);
    bottom.style.border = '0';
    bottom.style.borderTop = '1px solid var(--line)';
    bottom.style.borderRadius = '0 0 10px 10px';
    wrapCell.appendChild(top); wrapCell.appendChild(bottom);
    return wrapCell;
  }

	rows.forEach(function(count, rIndex){
	  var row = el('div',{class:'port-row'});
	  row.style.gridTemplateColumns = fullWidth ? 'repeat(12, var(--portW12))' : 'repeat(6, var(--portW6))';
	  row.style.gap = fullWidth ? 'var(--portGapFull)' : 'var(--portGapHalf)';
	  for (var c=0; c<count; c++){
		var p = seqByRow[rIndex][c];
		row.appendChild(renderPortCell(d, p));
	  }
	  portsContainer.appendChild(row);
	});

  var card = el('div',{class:'device', id:'dev-'+d.id}, head, meta, portsContainer);
  wrap.appendChild(card);
  return wrap;
}

/* ===================== CHANGE PORT COUNT ===================== */
function changePorts(d, newCount){
  newCount = Math.max(1, Math.min(9999, Number(newCount)||1));
  if (newCount === d.ports) return;
  if (newCount < d.ports){
    state.links = state.links.filter(function(L){
      var aOk = !(L.a.deviceId===d.id && L.a.port>newCount);
      var bOk = !(L.b.deviceId===d.id && L.b.port>newCount);
      return aOk && bOk;
    });
    Object.keys(state.portAliases).forEach(function(k){
      var parts = k.split(':'); if(parts[0]===d.id && Number(parts[1])>newCount) delete state.portAliases[k];
    });
    Object.keys(state.reservedPorts).forEach(function(k){
      var parts = k.split(':'); if(parts[0]===d.id && Number(parts[1])>newCount) delete state.reservedPorts[k];
    });
  }
  d.ports = newCount;
}

/* ===================== CONNECTIONS TABLE ===================== */
function renderConnections(){
  var tb = $('#connBody'); tb.innerHTML='';
  var q = ($('#searchBox').value||'').toLowerCase().trim();
  var rows = [];
  state.links.forEach(function(L, i){
    var da = deviceById(L.a.deviceId), db = deviceById(L.b.deviceId);
    var aName = (da&&da.name)||'Unknown', bName = (db&&db.name)||'Unknown';
    var aAlias = aliasFor(L.a.deviceId,L.a.port,L.a.sub), bAlias = aliasFor(L.b.deviceId,L.b.port,L.b.sub);

    var parts = [
      aName, 'port'+L.a.port, 'port '+L.a.port, String(L.a.port),
      bName, 'port'+L.b.port, 'port '+L.b.port, String(L.b.port),
      aAlias, bAlias
    ];
    var text = parts.join(' ').toLowerCase();
    if(q && text.indexOf(q)===-1) return;

    var aColor = da ? (da.color || '#ccc') : '#ccc';
    var bColor = db ? (db.color || '#ccc') : '#ccc';

    var tr = el('tr',{class:'conn-row', dataset:{linkId:L.id}},
      el('td',{}, String(i+1)),
      el('td',{class:'deviceA'}, el('span',{class:'devName', style:'--devColor:'+aColor, title:aName}, aName)),
      el('td',{}, 'Port '+L.a.port + (L.a.sub!=null?('/'+(L.a.sub+1)) : '')),
      el('td',{}, aAlias),
      el('td',{}, '‚áÑ'),
      el('td',{class:'deviceB'}, el('span',{class:'devName', style:'--devColor:'+bColor, title:bName}, bName)),
      el('td',{}, 'Port '+L.b.port + (L.b.sub!=null?('/'+(L.b.sub+1)) : '')),
      el('td',{}, bAlias),
      el('td',{}, el('button',{class:'btn-danger',onclick:function(){ unlink(L.id); }},'Unlink'))
    );

    tr.addEventListener('click', function(e){
      if(e.target.tagName.toLowerCase()==='button') return;
      if (highlightedLinkId === L.id){ highlightLink(null); clearSelectionOutlines(); return; }
      highlightLink(L.id);
      function sel(ep){ var s='.port[data-device-id="'+ep.deviceId+'"][data-port="'+ep.port+'"]'; if(ep.sub!=null) s+='[data-sub="'+ep.sub+'"]'; return s; }
      clearSelectionOutlines();
      var portA = document.querySelector(sel(L.a));
      var portB = document.querySelector(sel(L.b));
      if(portA) outlineForSelection(portA);
      if(portB) outlineForSelection(portB);
    });
	
	tr.addEventListener('mouseenter', function(e){
  if (!tr.classList.contains('highlight')) return;
  var html =
    '<div class="hc-title">Connection</div>' +
    '<div class="hc-row"><div class="hc-k">A</div><div>' + aName + ' ‚Ä¢ Port ' + L.a.port + (L.a.sub!=null?('/'+(L.a.sub+1)):'') + (aAlias?(' ‚Ä¢ '+aAlias):'') + '</div></div>' +
    '<div class="hc-row"><div class="hc-k">B</div><div>' + bName + ' ‚Ä¢ Port ' + L.b.port + (L.b.sub!=null?('/'+(L.b.sub+1)):'') + (bAlias?(' ‚Ä¢ '+bAlias):'') + '</div></div>';
  hcShowForTarget(tr, html, e);
});
tr.addEventListener('mousemove', function(e){
  if (!tr.classList.contains('highlight')) return;
  hcShowForTarget(tr, __hoverEl && __hoverEl.innerHTML || '', e);
});
tr.addEventListener('mouseleave', hcHide);


    rows.push(tr);
  });

  if (state.reservedPorts){
    Object.keys(state.reservedPorts).forEach(function(k){
      var parts = k.split(':');
      var devId = parts[0];
      var port  = Number(parts[1]);
      var sub   = (parts[2] === '' ? null : Number(parts[2]));
      var d     = deviceById(devId);
      if(!d) return;

      var rLabel = state.reservedPorts[k];
      var alias  = aliasFor(devId, port, sub);

      var textParts = [
        (d && d.name)||'Unknown',
        'port'+port, 'port '+port, String(port),
        alias||'', rLabel||'',
        (sub!=null ? (sub===0?'top':'bottom') : '')
      ];
      var text = textParts.join(' ').toLowerCase();
      if(q && text.indexOf(q)===-1) return;

      var tr = el('tr',{class:'conn-row reserved-row', dataset:{deviceId:devId, port:String(port), sub:(sub==null?'':String(sub))}},
        el('td',{}, '‚Äî'),
        el('td',{class:'deviceA'}, el('span',{class:'devName', style:'--devColor:'+(d.color||'#ccc'), title:d.name}, d.name)),
        el('td',{}, 'Port '+port + (sub!=null?('/'+(sub+1)) : '')),
        el('td',{}, alias || ''),
        el('td',{}, '‚üÇ'),
        el('td',{class:'deviceB'}, el('span',{class:'devName', style:'--devColor:#666', title:'Reserved'}, 'Reserved')),
        el('td',{}, '‚Äî'),
        el('td',{}, rLabel || ''),
        el('td',{}, el('button',{class:'btn-danger',onclick:function(){
          delete state.reservedPorts[k];
          saveStore(); render();
        }}, 'Clear'))
      );

      tr.addEventListener('click', function(e){
        if(e.target.tagName.toLowerCase()==='button') return;
        highlightedLinkId = null; applyRowHighlight(); clearSelectionOutlines();
        var sel = '.port[data-device-id="'+devId+'"][data-port="'+port+'"]' + (sub!=null?('[data-sub="'+sub+'"]'):'');
        var n = document.querySelector(sel);
        if(n) outlineForSelection(n);
      });

      rows.push(tr);
    });
  }

  if(!rows.length){
    tb.appendChild(el('tr',{}, el('td',{colspan:'9',class:'muted'},'No connections found.')));
  } else rows.forEach(function(r){ tb.appendChild(r); });
  applyRowHighlight();
}
function applyRowHighlight(){ $all('.conn-row').forEach(function(r){ if(highlightedLinkId && r.dataset.linkId===highlightedLinkId) r.classList.add('highlight'); else r.classList.remove('highlight'); }); }
function highlightLink(linkId, opts){
  highlightedLinkId = linkId; applyRowHighlight(); clearSelectionOutlines();
  if (!linkId) return;
  var L = state.links.find(function(x){ return x.id===linkId; }); if (!L) return;
  function sel(ep){ var s='.port[data-device-id="'+ep.deviceId+'"][data-port="'+ep.port+'"]'; if(ep.sub!=null) s+='[data-sub="'+ep.sub+'"]'; return s; }
  var portA = document.querySelector(sel(L.a));
  var portB = document.querySelector(sel(L.b));
  if (portA) outlineForSelection(portA);
  if (portB) outlineForSelection(portB);
  if (opts && opts.from){
    var origin = document.querySelector(sel(opts.from));
    if (origin){ outlineForSelection(origin); }
  }
}
function unlink(linkId){
  state.links = state.links.filter(function(L){ return L.id!==linkId; });
  if(highlightedLinkId===linkId) highlightedLinkId=null;
  saveStore(); render();
}

/* ------- Speed picker (context menu) ------- */
var __speedMenu = null;
var __menuOpen = false;

function closeSpeedMenu(){
  if(__speedMenu){
    __speedMenu.remove();
    __speedMenu = null;
  }
  __menuOpen = false;
  hcHide();
  clearSelectionOutlines();
}


function openSpeedMenu(e, deviceId, port, sub){
  closeSpeedMenu();
  e.preventDefault();
  
  __menuOpen = true;
  hcHide();
  
  clearSelectionOutlines();
	const portEl = document.querySelector(
	  `.port[data-device-id="${deviceId}"][data-port="${port}"]${sub != null ? `[data-sub="${sub}"]` : ''}`
	);
	if (portEl) outlineForSelection(portEl);

  var curSpeed = speedFor(deviceId, port, sub) || '';
  var curVlan  = vlanFor(deviceId, port, sub);
  var curVlanStr = (curVlan === '' ? '' : String(curVlan));

  var div = document.createElement('div');
  div.className = 'speed-menu';
  div.innerHTML =
    '<div style="font-size:12px;margin-bottom:6px;font-weight:600">Port settings</div>' +

	(store.settings.enablePortRename ? (
	  '<div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:6px">' +
		'<label for="__nameInput" style="margin:0;white-space:nowrap;min-width:70px">Port name</label>' +
		'<input id="__nameInput" type="text" placeholder="e.g. Channel 1" ' +
			   'style="flex:1;padding:4px 6px;font-size:12px;border-radius:6px;' +
					  'border:1px solid var(--line);background:var(--bg);color:var(--ink)">' +
		'<button id="__nameReset" type="button" title="Reset to default" ' +
			   'style="padding:4px 6px;font-size:11px;border-radius:6px;border:1px solid var(--line);' +
					  'background:var(--bg);color:var(--ink);cursor:pointer;">‚Ü∫</button>' +
	  '</div>'
	) : '') +

    '<div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:6px">' +
      '<label for="__aliasInput" style="margin:0;white-space:nowrap;min-width:70px">Alias</label>' +
      '<input id="__aliasInput" type="text" placeholder="Alias (optional)" ' +
             'style="flex:1;padding:4px 6px;font-size:12px;border-radius:6px;' +
                    'border:1px solid var(--line);background:var(--bg);color:var(--ink)">' +
    '</div>' +
	
    '<div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:6px">' +
      '<label for="__speedSelect" style="margin:0;white-space:nowrap;min-width:70px">Link speed</label>' +
      '<select id="__speedSelect" style="flex:1">' +
        '<option value="">(none)</option>' +
        '<option>100 Mbit</option><option>1 Gbit</option><option>2.5 Gbit</option>' +
        '<option>5 Gbit</option><option>10 Gbit</option><option>25 Gbit</option>' +
        '<option>40 Gbit</option><option>100 Gbit</option>' +
      '</select>' +
    '</div>' +

    '<div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:8px">' +
      '<label for="__vlanInput" style="margin:0;white-space:nowrap;min-width:70px">VLAN</label>' +
      '<input id="__vlanInput" type="number" min="1" max="4094" step="1" placeholder="1‚Äì4094" ' +
             'style="flex:1;padding:4px 6px;font-size:12px;border-radius:6px;border:1px solid var(--line);' +
                    'background:var(--bg);color:var(--ink)">' +
    '</div>' +

    '<div style="display:flex;gap:6px;justify-content:flex-end">' +
      '<button id="__speedCancel" class="btn" type="button">Cancel</button>' +
      '<button id="__speedSave"   class="btn" type="button" style="font-weight:700">Save</button>' +
    '</div>';

  document.body.appendChild(div);
  __speedMenu = div;

  div.addEventListener('mousedown', function(ev){ ev.stopPropagation(); }, { capture:true });
	var nin = div.querySelector('#__nameInput');
	if (nin) {
	  const dev = deviceById(deviceId);
	  const currentName =
		(dev && dev.portNames && dev.portNames[keyFor(deviceId, port, sub)]) ||
		('Port ' + port + (sub != null ? '/' + (sub + 1) : ''));
	  nin.value = currentName;
	}
	const resetBtn = div.querySelector('#__nameReset');
	if (resetBtn && nin) {
	  resetBtn.addEventListener('click', () => {
		const def = 'Port ' + port + (sub != null ? '/' + (sub + 1) : '');
		nin.value = def;
	  });
	}

  var ain = div.querySelector('#__aliasInput');
  var sel = div.querySelector('#__speedSelect');
  var vin = div.querySelector('#__vlanInput');
  ain.value = aliasFor(deviceId, port, sub) || '';
  sel.value = curSpeed || '';
  vin.value = curVlanStr;

  var x = e.clientX, y = e.clientY;
  var vw = window.innerWidth, vh = window.innerHeight;
  var rw = 260, rh = 130;
  if (x + rw + 8 > vw) x = vw - rw - 8;
  if (y + rh + 8 > vh) y = vh - rh - 8;
  div.style.left = x + 'px';
  div.style.top  = y + 'px';

  function doSave(){
  if (store.settings.enablePortRename && nin) {
  var newName = nin.value.trim() || ('Port ' + port + (sub != null ? '/' + (sub + 1) : ''));
  var dev = deviceById(deviceId);
  if (dev) {
    // Replace prefix only for this port label
    dev.portNames = dev.portNames || {};
    dev.portNames[keyFor(deviceId, port, sub)] = newName;
  }
}
    var aliasRaw = ain.value.trim();
    var aliasKey = keyFor(deviceId, port, sub);
    if (!aliasRaw) delete state.portAliases[aliasKey];
    else state.portAliases[aliasKey] = aliasRaw;
    var speedVal = sel.value || '';
    var vlanRaw  = vin.value.trim();
    var vlanVal  = vlanRaw === '' ? '' : Math.max(1, Math.min(4094, Number(vlanRaw) || 0));

    setSpeedFor(deviceId, port, sub, speedVal);
    setVlanFor(deviceId, port, sub, vlanVal);
    render();
    closeSpeedMenu();
  }

  div.querySelector('#__speedSave').addEventListener('click', doSave);
  div.querySelector('#__speedCancel').addEventListener('click', closeSpeedMenu);
  vin.addEventListener('keydown', function(ev){
    if (ev.key === 'Enter') doSave();
    if (ev.key === 'Escape') closeSpeedMenu();
  });

  setTimeout(function(){
    function onDoc(e2){
      if (__speedMenu && !__speedMenu.contains(e2.target)) closeSpeedMenu();
    }
    function onEsc(e2){ if (e2.key==='Escape') closeSpeedMenu(); }
    document.addEventListener('mousedown', onDoc, { once:true, capture:true });
    document.addEventListener('keydown', onEsc, { once:true });
    window.addEventListener('wheel', closeSpeedMenu, { once:true, passive:true });
  }, 0);
}



/* ===================== PRINT ===================== */
function openPrintSheet(includeTable){
  var devicesHTML = document.getElementById('devRows').innerHTML;
  var tableEl = document.getElementById('connTable');
  var tableHTML = (includeTable && tableEl) ? tableEl.outerHTML : '';
  var when = new Date().toLocaleString();

  var css = ''
+ '@page{size:A4 portrait;margin:12mm}\n'
+ '@page:first{size:A4 landscape;margin:12mm}\n'
+ '*{box-sizing:border-box}\n'
+ '@media print{*{-webkit-print-color-adjust:exact;print-color-adjust:exact}}\n'
+ '.device,.port,.dual-cell,.swatch,header{ -webkit-print-color-adjust:exact; print-color-adjust:exact }\n'
+ '.page{break-inside:avoid;page-break-inside:avoid}\n'
+ '.page + .page{break-before:page;page-break-before:always}\n'
+ ':root{--ink:#111;--line:#ddd;--prtPortH:75px;--prtGap:0px}\n'
+ '.port{height:var(--prtPortH)!important;box-sizing:border-box;overflow:hidden;display:block}\n'
+ '.dual-cell{display:flex;flex-direction:column;gap:var(--prtGap);height:calc(var(--prtPortH)*2 + var(--prtGap))!important;box-sizing:border-box;overflow:hidden}\n'
+ '.dual-cell .port{height:var(--prtPortH)!important;border:0!important;border-radius:0!important}\n'
+ '.dual-cell .port:first-child{border-bottom:1px solid #333!important}\n'

  + '*{box-sizing:border-box}\n'
  + 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;margin:0}\n'
  + '.page{max-width:calc(297mm - 16mm);margin:10mm auto}\n'
  + 'header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:12px}\n'
  + 'h1{font-size:18px;margin:0}\n'
  + '.meta{font-size:12px;color:#555}\n'
  + '.dev-rows{display:flex;flex-direction:column;gap:12px}\n'
  + '.dev-row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}\n'
  + '.device-wrap{width:100%}\n'
  + '.device-wrap.full{grid-column:1 / -1}\n'
  + '.device{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;overflow:hidden}\n'
  + '.device-head{display:flex;align-items:baseline;justify-content:space-between;gap:8px}\n'
  + '.device-title{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}\n'
  + '.device-actions,.inline-controls{display:none!important}\n'
  + '.swatch{width:12px;height:12px;border-radius:3px;border:1px solid #0003;display:inline-block}\n'
  + '.ports-rows{display:flex;flex-direction:column;gap:8px;margin-top:10px;overflow:hidden}\n'
  + '.port-row{display:grid;justify-content:start;align-content:start}\n'
  + '.device-wrap.full .port-row{grid-template-columns:repeat(12,minmax(40px,1fr));gap:10px !important;}\n'
  + '.device-wrap:not(.full) .port-row{grid-template-columns:repeat(6,minmax(40px,1fr));gap:7px !important;}\n'
  /* --------------------------------------------------------------------------- */
  + '.port{border:1px solid #333;border-radius:8px;padding:6px 3px 4px;text-align:center;grid-column:auto!important;width:auto!important}\n'
  + '.port .num{font-size:12px;font-weight:600}\n'
  + '.port .alias{font-size:11px;margin-top:2px;min-height:1.1em}\n'
  + '.port .peer{font-size:12px;font-weight:700;margin-top:4px;min-height:1.2em}\n'
  + '.port:not(.connected):not(.reserved){background:#fff !important;border-color:#444 !important}\n'
  + '.port:not(.connected):not(.reserved) .num,'
  + '.port:not(.connected):not(.reserved) .alias,'
  + '.port:not(.connected):not(.reserved) .peer{color:#000 !important}\n'
  + '.port.connected{color:#000}\n'
  + '.port.reserved{background:#555 !important;color:#fff !important;border-color:#333 !important}\n'
  + '.dual-cell{border-color:#333 !important}\n'
  + '.port.reserved .num,.port.reserved .alias,.port.reserved .peer{color:#fff !important}\n'
  + 'table{width:100%;border-collapse:collapse;margin-top:16px}\n'
  + 'th,td{border:1px solid var(--line);padding:6px 8px;font-size:12px;text-align:left}\n'
  + 'th{background:#f6f7f9;font-weight:700}\n'
  + 'th:last-child, td:last-child{display:none}\n'
  + '@media print{.controls{display:none};}\n';


  var html = ''
  + '<!doctype html><html><head><meta charset="utf-8">'
  + '<title>Ethernet Cable Connection Manager ‚Äì Print</title><style>' + css + '</style></head><body>'
  + '<div class="page">'
  + '<header><h1>Profile: ' + store.current + '</h1><div class="meta">' + 'Ethernet Cable Connection Manager: <a href="https://https://github.com/bijomaru78/eccm" target="_blank">https://github.com/bijomaru78/eccm</a> - Printed on '+when+'</div></header>' 
  + '<section id="printDevices" class="dev-rows">' + devicesHTML + '</section>'
  + (tableHTML ? '<div class="page"><h2 style="font-size:16px;margin:18px 0 8px">Connections</h2>' + tableHTML + '</div>' : '')
  + '<div class="controls" style="margin-top:12px"><button onclick="window.print()">Print</button></div>'
  + '</div>'
  + '<script>(function(){'
  + '  var GAP_FULL=9, GAP_HALF=7, MIN_TRACK=40;'
  + '  function sizeRows(){'
  + '    var rows=document.querySelectorAll(".port-row,[data-port-row]");'
  + '    for(var i=0;i<rows.length;i++){'
  + '      var row=rows[i];'
  + '      var wrap=row.closest(".device-wrap");'
  + '      row.style.display = "grid";'
  + '      row.style.justifyContent = "start";'
  + '      row.style.alignContent = "start";'
  + '      row.style.gridAutoFlow = "row";'
  + '      var isFull = wrap && wrap.classList.contains("full");'
  + '      var cols   = isFull ? 12 : 6;'
  + '      var gap    = isFull ? GAP_FULL : GAP_HALF;'
  + '      var inner = row.getBoundingClientRect().width;'
  + '      if(inner && inner > 0){'
  + '        var track = Math.floor((inner - gap * (cols - 1)) / cols);'
  + '        if (!(track > 0)) track = 60;'
  + '        if (track < MIN_TRACK) track = MIN_TRACK;'
  + '		 track += -3;'
  + '        row.style.gridTemplateColumns = "repeat(" + cols + ", " + track + "px)";'
  + '      }'
  + '      row.style.gap = gap + "px";'
  + '    }'
  + '  }'
  + '  requestAnimationFrame(function(){ requestAnimationFrame(sizeRows); });'
  + '  Array.prototype.forEach.call(document.querySelectorAll(".port"),function(p){'
  + '    if(!p.classList.contains("connected") && !p.classList.contains("reserved")){'
  + '      p.style.background=""; p.style.color="";'
  + '      p.querySelectorAll(".num,.alias,.peer").forEach(function(el){ el.style.color=""; });'
  + '    }'
  + '  });'
  + '  Array.prototype.forEach.call(document.querySelectorAll("[draggable]"),function(el){el.removeAttribute("draggable");});'
  + '})();<\/script>'
  + '</body></html>';

  var win = window.open('', '_blank');
  win.document.open();
  win.document.write(html);
  win.document.close();
  
  win.onload = function() {
  win.focus();
  setTimeout(function() {
    win.print();
    win.close();
  }, 30); 
};
}



/* ===================== ORCHESTRATION ===================== */
function render(){ renderDevices(); renderConnections(); }

/* ===================== PALETTE ===================== */
(function(){
  const palette = [
  '#FFCDD2','#C8E6C9','#BBDEFB','#F5F5F5',
  '#F44336','#4CAF50','#2196F3','#E0E0E0',
  '#FF0000','#00FF00','#0000FF','#BDBDBD',
  '#FF6F00','#FFFF00','#BF00FF','#9E9E9E',
  '#FF9800','#FFEB3B','#9C27B0','#757575',
  '#FFB74D','#FFF176','#BA68C8','#616161'
]

   const modal   = document.getElementById('paletteModal');
  const grid    = document.getElementById('paletteGrid');
  const openBtn = document.getElementById('openPalette');
  const closeBtn= document.getElementById('paletteClose');
  const previewSidebar = document.getElementById('devColorPreview');
  let chosenColor = '#E74C3C';

  function open(){ modal.style.display='flex'; }
  function close(){ modal.style.display='none'; }
  function updatePreview(){ previewSidebar.style.background = chosenColor; }

  /* ---------- RGB / HSV conversion helpers ---------- */
  function rgbToHex(r,g,b){
    return '#' + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('').toUpperCase();
  }
  function hexToRgb(hex){
    const n = parseInt(hex.replace('#',''),16);
    return {r:(n>>16)&255, g:(n>>8)&255, b:n&255};
  }
  function rgbToHsv(r, g, b) {
    r/=255; g/=255; b/=255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    const d = max-min;
    let h,s,v = max;
    s = max===0 ? 0 : d/max;
    if(max===min) h=0;
    else {
      switch(max){
        case r: h=(g-b)/d + (g<b?6:0); break;
        case g: h=(b-r)/d + 2; break;
        case b: h=(r-g)/d + 4; break;
      }
      h /= 6;
    }
    return {h:h*360, s:s*100, v:v*100};
  }
  function hsvToRgb(h, s, v){
    h/=360; s/=100; v/=100;
    const i = Math.floor(h*6);
    const f = h*6 - i;
    const p = v*(1-s);
    const q = v*(1-f*s);
    const t = v*(1-(1-f)*s);
    let r,g,b;
    switch(i%6){
      case 0: r=v; g=t; b=p; break;
      case 1: r=q; g=v; b=p; break;
      case 2: r=p; g=v; b=t; break;
      case 3: r=p; g=q; b=v; break;
      case 4: r=t; g=p; b=v; break;
      case 5: r=v; g=p; b=q; break;
    }
    return {r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255)};
  }

  /* ---------- Build palette grid ---------- */
  grid.innerHTML = '';
  palette.forEach(hex=>{
    const chip = document.createElement('button');
    chip.className='chip';
    chip.style.background=hex;
    chip.title=hex;
    chip.addEventListener('click',()=>{
      chosenColor=hex;
      updateFromHex(hex);
      updatePreview();
    });
    grid.appendChild(chip);
  });

  /* ---------- Add custom sliders ---------- */
const customHTML = `
  <div id="customColorPicker"
       style="display:grid;
              grid-template-columns:repeat(5,1fr);
              grid-template-rows:auto auto auto;
              gap:12px;
              align-items:center;
              justify-items:center;
              margin-left:12px;
              margin-top:6px;">

    <!-- Headers -->
    <div style="font-size:12px;color:var(--muted)">Hue</div>
    <div style="font-size:12px;color:var(--muted)">Sat</div>
    <div style="font-size:12px;color:var(--muted)">R</div>
    <div style="font-size:12px;color:var(--muted)">G</div>
    <div style="font-size:12px;color:var(--muted)">B</div>

    <!-- Sliders -->
<div id="hueWrap"
     style="position:relative;height:120px;width:16px;display:flex;align-items:center;justify-content:center;">
  <!-- static hue gradient -->
  <div id="hueBar"
       style="position:absolute;inset:0;
              background:linear-gradient(to top, red, yellow, lime, cyan, blue, magenta, red);
              border-radius:6px;filter:brightness(0.9);">
  </div>
  <!-- moving indicator -->
  <div id="hueMarker"
       style="position:absolute;left:0;right:0;height:2px;background:white;
              border-radius:1px;box-shadow:0 0 4px rgba(0,0,0,0.8);pointer-events:none;">
  </div>
  <!-- functional slider -->
  <input type="range" id="hueSlider" min="0" max="360"
         style="position:relative;z-index:5;height:120px;width:16px;
                appearance:slider-vertical;writing-mode:bt-lr;
                opacity:0;">
</div>

    <input type="range" id="satSlider" min="0" max="100"
           style="height:120px;width:10px;appearance:slider-vertical;writing-mode:bt-lr;">
    <input type="range" id="rSlider" min="0" max="255"
           style="height:120px;width:10px;appearance:slider-vertical;writing-mode:bt-lr;">
    <input type="range" id="gSlider" min="0" max="255"
           style="height:120px;width:10px;appearance:slider-vertical;writing-mode:bt-lr;">
    <input type="range" id="bSlider" min="0" max="255"
           style="height:120px;width:10px;appearance:slider-vertical;writing-mode:bt-lr;">

<!-- Preview -->
<div id="colorPreviewBox"
     style="grid-column:1 / span 5;
            width:36px;height:36px;
            border-radius:8px;
            border:1px solid #333;
            box-shadow:0 0 8px rgba(0,0,0,0.25);
            margin-top:10px;"></div>

<!-- Hex field (editable) -->
<input type="text" id="hexOutput"
       placeholder="#RRGGBB"
       style="grid-column:1 / span 5;
              width:110px;
              text-align:center;
              font-size:13px;
              background:#0f141d;
              border:1px solid var(--line);
              border-radius:6px;
              color:var(--ink);
              padding:5px;
              margin-top:6px;">

  </div>`;


  grid.insertAdjacentHTML('afterend', customHTML);

  /* ---------- DOM refs ---------- */
  const hSlider=document.getElementById('hueSlider');
  const sSlider=document.getElementById('satSlider');
  const rSlider=document.getElementById('rSlider');
  const gSlider=document.getElementById('gSlider');
  const bSlider=document.getElementById('bSlider');
  const colorBox=document.getElementById('colorPreviewBox');
  const hexOut=document.getElementById('hexOutput');

  /* ---------- Core update logic ---------- */
  function updatePreviewBox(hex){
    colorBox.style.background=hex;
    hexOut.value=hex.toUpperCase();
    chosenColor=hex;
    updatePreview();
  }
  
  function updateHueMarker() {
  const hue = +hSlider.value || 0;
  const marker = document.getElementById('hueMarker');
  if (!marker) return;
  const bar = document.getElementById('hueWrap');
  const height = bar ? bar.clientHeight : 120;
  const pos = height - (hue / 360) * height; // invert so 0¬∞=bottom, 360¬∞=top
  marker.style.top = `${pos - 1}px`;
}


  function updateFromRGB(){
    const r=+rSlider.value, g=+gSlider.value, b=+bSlider.value;
    const hex=rgbToHex(r,g,b);
    const {h,s}=rgbToHsv(r,g,b);
    hSlider.value=Math.round(h);
    sSlider.value=Math.round(s);
    updatePreviewBox(hex);
	updateHueMarker();
  }

  function updateFromHSV(){
    const h=+hSlider.value, s=+sSlider.value;
    const {r,g,b}=hsvToRgb(h,s,100);
    rSlider.value=r; gSlider.value=g; bSlider.value=b;
    const hex=rgbToHex(r,g,b);
    updatePreviewBox(hex);
	updateHueMarker();
  }

  function updateFromHex(hex){
    const {r,g,b}=hexToRgb(hex);
    rSlider.value=r; gSlider.value=g; bSlider.value=b;
    const {h,s}=rgbToHsv(r,g,b);
    hSlider.value=Math.round(h);
    sSlider.value=Math.round(s);
    updatePreviewBox(hex);
	updateHueMarker();
  }

  /* ---------- Events ---------- */
  [rSlider,gSlider,bSlider].forEach(sl=>sl.addEventListener('input',updateFromRGB));
  [hSlider,sSlider].forEach(sl=>sl.addEventListener('input',updateFromHSV));
	hexOut.addEventListener('input', e => {
	  const v = e.target.value.trim();
	  // allow partial input like "#ff" without breaking live update
	  if (/^#?[0-9A-Fa-f]{0,6}$/.test(v)) {
		e.target.style.borderColor = 'var(--line)';
	  } else {
		e.target.style.borderColor = '#d33'; // red outline if invalid
		return;
	  }
	  if (/^#?[0-9A-Fa-f]{6}$/.test(v)) {
		const hex = v.startsWith('#') ? v.toUpperCase() : '#' + v.toUpperCase();
		updateFromHex(hex);
	  }
	});


  /* ---------- Modal + Add device ---------- */
  openBtn.addEventListener('click',open);
  closeBtn.addEventListener('click',close);

  document.getElementById('addBtn').addEventListener('click',function(){
    const name=document.getElementById('devName').value.trim();
    const ports=Math.max(1,Math.min(9999,Number(document.getElementById('devPorts').value)||1));
    if(!name){alert('Please enter a device name.');return;}
    state.devices.push({
      id:uid(),name,ports,color:chosenColor,
      forceFullRow:false,midWrapMode:'balanced',smallWrap:false,dualLink:false,
      numbering:'row'
    });
    document.getElementById('devName').value='';
    saveStore();render();
  });

  updateFromHex(chosenColor);
  updateHueMarker();
})();


/* ===================== LAYOUT MODAL ===================== */
function openLayoutModal(deviceId){
  var d = deviceById(deviceId); if (!d) return;
  var backdrop = $('#layoutModal');
  var nameEl = $('#layoutDeviceName');
  var selFull = $('#layoutFullRow');
  var selMid = $('#layoutMidWrap');
  var selSmall = $('#layoutSmallWrap');
  var selDual = $('#layoutDualLink');
  var rowMid = $('#optMidWrap');
  var rowSmall = $('#optSmallWrap');
  var selNumbering = $('#layoutNumbering');


  nameEl.textContent = d.name + ' ('+d.ports+' ports)';
  selFull.value = d.forceFullRow ? 'full' : 'auto';
  selMid.value = (d.midWrapMode === 'twelve') ? 'twelve' : 'balanced';
  selSmall.value = d.smallWrap ? 'split' : 'single';
  selDual.value = d.dualLink ? 'on' : 'off';
  selNumbering.value = (d.numbering === 'column') ? 'column' : 'row';

  rowMid.style.display   = (d.ports>=13 && d.ports<=24) ? 'flex' : 'none';
  rowSmall.style.display = (d.ports>=7  && d.ports<=12) ? 'flex' : 'none';

  $('#layoutCancel').onclick = function(){ backdrop.style.display='none'; };
  $('#layoutSave').onclick = function(){
    d.forceFullRow = (selFull.value === 'full');
    if (d.ports>=13 && d.ports<=24) d.midWrapMode = (selMid.value === 'twelve') ? 'twelve' : 'balanced';
    if (d.ports>=7  && d.ports<=12) d.smallWrap   = (selSmall.value === 'split');
    d.dualLink = (selDual.value === 'on');
	d.numbering = (selNumbering.value === 'column') ? 'column' : 'row';
    saveStore(); backdrop.style.display='none'; render();
  };
  /* --- allow Escape key & outside click to close Layout modal --- */
(function wireLayoutModalClose() {
  const modal = document.getElementById('layoutModal');
  if (!modal) return;

  // Close on Escape
  document.addEventListener('keydown', function (e) {
    if (modal.style.display === 'flex' && e.key === 'Escape') {
      modal.style.display = 'none';
    }
  });

  // Close when clicking backdrop (outside the inner .modal)
  modal.addEventListener('click', function (e) {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
})();

  backdrop.style.display = 'flex';
}

/* ===================== EDIT DEVICE MODAL ===================== */
let currentEditDevice = null;
let editChosenColor = '#888';

function openEditDeviceModal(deviceId) {
  const d = deviceById(deviceId);
  if (!d) return;

  currentEditDevice = d;
  const modal = document.getElementById('editDeviceModal');
  const nameInput = document.getElementById('editDevName');
  const portsInput = document.getElementById('editDevPorts');
  const preview = document.getElementById('editDevColorPreview');

  nameInput.value = d.name || '';
  portsInput.value = d.ports || 1;
  editChosenColor = d.color || '#888';
  preview.style.background = editChosenColor;

  modal.style.display = 'flex';
}

function closeEditDeviceModal() {
  document.getElementById('editDeviceModal').style.display = 'none';
  currentEditDevice = null;
}

/* --- use main palette modal for Edit Device colour selection --- */
(function setupEditColorPicker() {
  const paletteModal = document.getElementById('paletteModal');
  const openBtn = document.getElementById('editOpenPalette');
  const preview = document.getElementById('editDevColorPreview');
  const paletteGrid = document.getElementById('paletteGrid');
  const closeBtn = document.getElementById('paletteClose');
  let tempTarget = null;

  // open shared palette modal but record the target (edit or add)
  openBtn.addEventListener('click', function () {
    tempTarget = 'edit';
    paletteModal.style.display = 'flex';
  });

  // intercept clicks in palette grid to update the correct target
  paletteGrid.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', function () {
      const hex = chip.title || chip.style.background;
      if (tempTarget === 'edit') {
        editChosenColor = hex;
        preview.style.background = hex;
      } else {
        // fallback for add device
        chosenColor = hex;
        document.getElementById('devColorPreview').style.background = hex;
      }
      paletteModal.style.display = 'none';
    });
  });

  // close palette normally
  closeBtn.addEventListener('click', function () {
    paletteModal.style.display = 'none';
    tempTarget = null;
  });
})();


/* --- modal buttons --- */
document.getElementById('editDevCancel').addEventListener('click', closeEditDeviceModal);
document.getElementById('editDevSave').addEventListener('click', function() {
  if (!currentEditDevice) return;
  const name = document.getElementById('editDevName').value.trim();
  const ports = Math.max(1, Math.min(9999, Number(document.getElementById('editDevPorts').value) || 1));
  currentEditDevice.name = name || currentEditDevice.name;
  changePorts(currentEditDevice, ports);
  currentEditDevice.color = editChosenColor;
  saveStore(); render();
  closeEditDeviceModal();
});
/* --- allow Escape key & outside click to close --- */
(function wireEditModalClose() {
  const modal = document.getElementById('editDeviceModal');
  if (!modal) return;

  // Close on Escape
  document.addEventListener('keydown', function (e) {
    if (modal.style.display === 'flex' && e.key === 'Escape') {
      closeEditDeviceModal();
    }
  });

  // Close when clicking outside the modal box
  modal.addEventListener('click', function (e) {
    if (e.target === modal) {
      closeEditDeviceModal();
    }
  });
})();


/* ===================== PROFILES UI ===================== */
function refreshProfileSelect(){
  var sel = document.getElementById('profileSelect');
  sel.innerHTML = '';
  Object.keys(store.profiles).forEach(function(name){
    var opt = document.createElement('option');
    opt.value = name; opt.textContent = name;
    if (name === store.current) opt.selected = true;
    sel.appendChild(opt);
  });
  sel.value = store.current;
}
function switchProfile(name){
  if (!store.profiles[name]) return;
  store.current = name;
  state = store.profiles[name];
  normalizeState(state);
  saveStore();
  refreshProfileSelect();
  render();
}
document.getElementById('profileSelect').addEventListener('change', function(){ switchProfile(this.value); });

document.getElementById('newProfileBtn').addEventListener('click', function(){
  var name = prompt('New profile name:', 'Customer '+(Object.keys(store.profiles).length+1));
  if(!name) return; name = name.trim(); if(!name) return;
  if(store.profiles[name]){ alert('A profile with that name already exists.'); return; }
  store.profiles[name] = deepClone(defaultState); saveStore();
  refreshProfileSelect(); switchProfile(name);
});

document.getElementById('renameProfileBtn').addEventListener('click', function(){
  var current = store.current;
  var name = prompt('Rename profile "'+current+'" to:', current);
  if(!name || !name.trim()) return; name = name.trim();
  if(name === current) return;
  if(store.profiles[name]){ alert('A profile with that name already exists.'); return; }
  store.profiles[name] = state; delete store.profiles[current];
  store.current = name; saveStore(); refreshProfileSelect(); render();
});

document.getElementById('duplicateProfileBtn').addEventListener('click', function(){
  var base = store.current;
  var name = prompt('Duplicate profile as:', base+' (copy)');
  if(!name || !name.trim()) return; name = name.trim();
  if(store.profiles[name]){ alert('A profile with that name already exists.'); return; }
  store.profiles[name] = deepClone(state); saveStore();
  refreshProfileSelect(); switchProfile(name);
});

document.getElementById('deleteProfileBtn').addEventListener('click', function(){
  var names = Object.keys(store.profiles);
  if(names.length<=1){ alert('You must keep at least one profile.'); return; }
  var current = store.current;
  if(!confirm('Delete profile "'+current+'"? This cannot be undone.')) return;
  delete store.profiles[current];
  var next = Object.keys(store.profiles)[0];
  store.current = next; state = store.profiles[next];
  saveStore(); refreshProfileSelect(); render();
});

/* Export profile (includes profileName) */
document.getElementById('exportProfileBtn').addEventListener('click', function(){
  var data = { profileName: store.current, devices: state.devices, links: state.links, portAliases: state.portAliases, reservedPorts: state.reservedPorts, exportedAt: new Date().toISOString() };
  var blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  var url = URL.createObjectURL(blob); var a = document.createElement('a');
  a.href = url; a.download = 'ethernet-profile-' + store.current.replace(/[^a-z0-9-_]+/gi,'_') + '.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* Import profile (suggest name, switch active) */
document.getElementById('importProfileBtn').addEventListener('click', function(){ document.getElementById('importProfileFile').click(); });
document.getElementById('importProfileFile').addEventListener('change', function(e){
  var file = e.target.files && e.target.files[0]; if(!file) return;
  var reader = new FileReader();
  reader.onload = function(){
    try{
      var parsed = JSON.parse(reader.result);
      if(!Array.isArray(parsed.devices) || !Array.isArray(parsed.links)) throw new Error('Invalid schema');
      parsed.portAliases = parsed.portAliases || {};
      parsed.reservedPorts = parsed.reservedPorts || {};

      var devices = parsed.devices.map(function(d){
		  return {
			id: d.id || uid(),
			name: String(d.name || 'Unnamed'),
			ports: Math.max(1, Math.min(512, Number(d.ports)||1)),
			color: d.color || '#888',
			forceFullRow: !!d.forceFullRow,
			midWrapMode: (d.midWrapMode === 'twelve' ? 'twelve' : 'balanced'),
			smallWrap: !!d.smallWrap,
			dualLink: !!d.dualLink,
			numbering: (d.numbering === 'column' ? 'column' : 'row')
		  };
		});

      var idSet = Object.create(null); devices.forEach(function(d){ idSet[d.id]=true; });

      var links = (parsed.links || []).map(function(L){
        return { id: L.id || uid(),
          a:{deviceId:String(L.a.deviceId), port:Number(L.a.port), sub:(L.a.sub==null?null:Number(L.a.sub))},
          b:{deviceId:String(L.b.deviceId), port:Number(L.b.port), sub:(L.b.sub==null?null:Number(L.b.sub))}
        };
      }).filter(function(L){ return idSet[L.a.deviceId] && idSet[L.b.deviceId] && L.a.port>=1 && L.b.port>=1; });

      var suggested = (parsed.profileName || '').toString().trim() || ('Imported ' + new Date().toLocaleString());
      var name = prompt('Name for imported profile:', suggested);
      if(!name || !name.trim()) return; name = name.trim();
      if(store.profiles[name]){ alert('A profile with that name already exists.'); return; }

      store.profiles[name] = { devices: devices, links: links, portAliases: parsed.portAliases, reservedPorts: parsed.reservedPorts };
      saveStore();
      refreshProfileSelect();
      switchProfile(name);
    }catch(err){ alert('Import failed: ' + err.message); }
    finally{ e.target.value=''; }
  };
  reader.readAsText(file);
});

/* ===================== BACKUP / RESTORE (all profiles) ===================== */
document.getElementById('backupAllBtn').addEventListener('click', function(){
  var blob = new Blob([JSON.stringify(store,null,2)], {type:'application/json'});
  var url = URL.createObjectURL(blob); var a = document.createElement('a');
  a.href = url; a.download = 'ethernet-all-profiles-backup.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('restoreAllBtn').addEventListener('click', function(){
  document.getElementById('restoreAllFile').click();
});
document.getElementById('restoreAllFile').addEventListener('change', function(e){
  var file = e.target.files && e.target.files[0]; if(!file) return;
  var reader = new FileReader();
  reader.onload = function(){
    try{
      var parsed = JSON.parse(reader.result);
      if(!parsed || !parsed.current || !parsed.profiles) throw new Error('Invalid backup file (missing profiles).');
      Object.keys(parsed.profiles).forEach(function(name){ normalizeState(parsed.profiles[name]); });
      store = parsed; state = store.profiles[store.current] || deepClone(defaultState);
      saveStore(); refreshProfileSelect(); render();
    }catch(err){ alert('Restore failed: ' + err.message); }
    finally{ e.target.value=''; }
  };
  reader.readAsText(file);
});

/* ===================== SEARCH + PRINT ===================== */
document.getElementById('searchBox').addEventListener('input', renderConnections);
document.getElementById('printSheet').addEventListener('click', function(){ openPrintSheet(true); });

/* ===================== CLEAR ALL (current profile only) ===================== */
document.getElementById('clearAll').addEventListener('click', function(){
  if(!confirm('Delete ALL devices and connections in profile "'+store.current+'"?')) return;
  store.profiles[store.current] = deepClone(defaultState);
  state = store.profiles[store.current];
  saveStore(); render();
});

/* ===================== GLOBAL BLANK-SPACE CLICK: CLEAR SELECTION ===================== */
document.addEventListener('click', function(e){
  if (
    e.target.closest('.port') ||
    e.target.closest('.conn-row') ||
    e.target.closest('.palette-backdrop') ||
    e.target.closest('.modal-backdrop') ||
    e.target.closest('.device-actions') ||
    e.target.closest('button, input, select, label')
  ){ return; }
  pendingPort = null; highlightLink(null); clearSelectionOutlines();
}, true);

/* ===================== SETTINGS ===================== */
if (!store.settings)
  store.settings = { maxPorts: 512, enablePortRename: false };

if (store.settings.enablePortRename === undefined)
  store.settings.enablePortRename = false;

function getMaxPortsSetting() {
  return Math.max(1, Number(store.settings?.maxPorts) || 512);
}

function saveSettings() {
  saveStore();
  applySettings();
}

function applySettings() {
  const maxPorts = getMaxPortsSetting();

  const devPorts = document.getElementById('devPorts');
  if (devPorts) {
    devPorts.max = String(maxPorts);
    if (Number(devPorts.value) > maxPorts) devPorts.value = String(maxPorts);
  }

  const maxPortsInput = document.getElementById('maxPorts');
  if (maxPortsInput) {
    maxPortsInput.value = String(maxPorts);
  }

  const enablePortRenameEl = document.getElementById('enablePortRename');
  if (enablePortRenameEl) {
    enablePortRenameEl.checked = !!store.settings.enablePortRename;
  }
}

applySettings();

const maxPortsInput = document.getElementById('maxPorts');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const enablePortRenameEl = document.getElementById('enablePortRename');

if (saveSettingsBtn && maxPortsInput && enablePortRenameEl) {
  saveSettingsBtn.addEventListener('click', () => {
    const val = Math.max(1, Number(maxPortsInput.value) || 9999);
    store.settings.maxPorts = val;
    store.settings.enablePortRename = !!enablePortRenameEl.checked;
    saveSettings();
	
	const modal = document.getElementById('settingsModal');
    if (modal) {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
    }
  });
}

if (enablePortRenameEl) {
  enablePortRenameEl.checked = !!store.settings.enablePortRename;
}

(function clampBeforeAdd() {
  const addBtn = document.getElementById('addBtn');
  const devPorts = document.getElementById('devPorts');
  if (!addBtn || !devPorts) return;

  devPorts.addEventListener('input', () => {
    const maxPorts = getMaxPortsSetting();
    let v = Math.max(1, Number(devPorts.value) || 1);
    if (v > maxPorts) v = maxPorts;
    devPorts.value = String(v);
  });

  addBtn.addEventListener(
    'click',
    () => {
      const maxPorts = getMaxPortsSetting();
      let v = Math.max(1, Number(devPorts.value) || 1);
      if (v > maxPorts) devPorts.value = String(maxPorts);
    },
    true
  );
})();

const __orig_changePorts = changePorts;
changePorts = function (d, newCount) {
  const maxPorts = getMaxPortsSetting();
  const clamped = Math.max(1, Math.min(maxPorts, Number(newCount) || 1));
  return __orig_changePorts(d, clamped);
};

/* ===================== INIT ===================== */
function initProfilesUI(){ refreshProfileSelect(); }
initProfilesUI();
render();
updateUniformPortWidth();


</script>

<script>
(function(){
  const STORE_KEY = 'elmStore';

  function safeLoad(){
    try { return JSON.parse(localStorage.getItem(STORE_KEY) || '{}'); }
    catch { return {}; }
  }
  function safeSave(obj){
    try { localStorage.setItem(STORE_KEY, JSON.stringify(obj)); } catch {}
  }

  function getStore(){
    const s = (window.store && typeof window.store === 'object') ? window.store : safeLoad();
    if (!s.settings) s.settings = {};
    if (!s.settings.theme) s.settings.theme = 'dark';
    return s;
  }

  function applyTheme(theme){
    document.documentElement.classList.toggle('theme-bright', theme === 'bright');
  }

  function persistTheme(theme){
    if (window.store && typeof window.store === 'object') {
      window.store.settings = window.store.settings || {};
      window.store.settings.theme = theme;
      if (typeof window.saveStore === 'function') {
        try { window.saveStore(); } catch {}
      } else {
        safeSave(window.store);
      }
    } else {
      const s = getStore();
      s.settings.theme = theme;
      safeSave(s);
    }
  }

  function init(){
    const store = getStore();
    applyTheme(store.settings.theme);

    var sel = document.getElementById('themeSelect');
    if (sel){
      sel.value = (store.settings.theme === 'bright') ? 'bright' : 'dark';
      sel.addEventListener('change', function(){
        const theme = sel.value;
        applyTheme(theme);
        persistTheme(theme);
        if (typeof window.render === 'function') {
          try { window.render(); } catch {}
        }
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
<script>
(function(){
  const LS_KEY = 'elmTheme';
  const getTheme = () => (localStorage.getItem(LS_KEY) === 'bright' ? 'bright' : 'dark');
  const applyTheme = (t) => document.documentElement.classList.toggle('theme-bright', t === 'bright');
  const setTheme = (t) => { localStorage.setItem(LS_KEY, t); applyTheme(t); updateButtons(t); if (typeof window.render==='function') { try{ render(); }catch{} } };

  function updateButtons(t){
    const darkBtn  = document.getElementById('themeDark');
    const lightBtn = document.getElementById('themeLight');
    if(!darkBtn || !lightBtn) return;
    const isBright = t === 'bright';
    darkBtn.classList.toggle('active', !isBright);
    lightBtn.classList.toggle('active', isBright);
    darkBtn.setAttribute('aria-pressed', String(!isBright));
    lightBtn.setAttribute('aria-pressed', String(isBright));
  }

  function wire(){
    const darkBtn  = document.getElementById('themeDark');
    const lightBtn = document.getElementById('themeLight');
    if(!darkBtn || !lightBtn) return;

    darkBtn.addEventListener('click',  () => setTheme('dark'));
    lightBtn.addEventListener('click', () => setTheme('bright'));

    const current = getTheme();
    applyTheme(current);
    updateButtons(current);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wire, { once:true });
  } else {
    wire();
  }
})();
</script>
<script>
(() => {
  const btn = document.getElementById('btnSettings');
  const modal = document.getElementById('settingsModal');
  const panel = modal?.querySelector('.slideover__panel');
  const closers = modal?.querySelectorAll('[data-close]');
  let lastFocused = null;

  function openSettings() {
    if (!modal) return;
    lastFocused = document.activeElement;
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    applySettings();
    setTimeout(() => panel?.focus(), 0);
    document.addEventListener('keydown', onKey);
    document.addEventListener('focus', trapFocus, true);
  }

  function closeSettings() {
    if (!modal) return;
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    document.removeEventListener('keydown', onKey);
    document.removeEventListener('focus', trapFocus, true);
    if (lastFocused && typeof lastFocused.focus === 'function') {
      lastFocused.focus();
    }
  }

  function onKey(e) {
    if (e.key === 'Escape') closeSettings();
  }

  function trapFocus(e) {
    if (!modal.classList.contains('is-open')) return;
    if (!panel.contains(e.target)) {
      e.stopPropagation();
      panel.focus();
    }
  }

  btn?.addEventListener('click', openSettings);
  closers?.forEach(el => el.addEventListener('click', closeSettings));
})();

/* ===================== UNIVERSAL ESCAPE HANDLER ===================== */
(function modalEscapeManager() {
  const modals = {
    palette: document.getElementById('paletteModal'),
    edit: document.getElementById('editDeviceModal'),
    layout: document.getElementById('layoutModal')
  };

  function isOpen(el) {
    return el && el.style.display === 'flex';
  }

  function closeTopmost() {
    if (isOpen(modals.palette)) {
      modals.palette.style.display = 'none';
      return true;
    }
    if (isOpen(modals.edit)) {
      modals.edit.style.display = 'none';
      currentEditDevice = null;
      return true;
    }
    if (isOpen(modals.layout)) {
      modals.layout.style.display = 'none';
      return true;
    }
    return false;
  }

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      const closed = closeTopmost();
      if (closed) {
        e.stopPropagation();
        e.preventDefault();
      }
    }
  });
})();

</script>
</body>
</html>
